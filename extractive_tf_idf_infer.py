# -*- coding: utf-8 -*-
"""extractive_tf-idf_infer.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fb70aDbE3gpeI4n_L5o_y1ca_TOn6Nci
"""
from fastapi import FastAPI, HTTPException
import heapq
import math

app = FastAPI()

def infere_extractive_summarize(paragraph , result_size):
    sentences_tokens = paragraph.split(".")
    documents = [];
    for sen in sentences_tokens:
        if len(sen)>2:
            documents.append(sen)
    dictOfWords = {}
    for index, sentence in enumerate(documents):
        tokenizedWords = sentence.split(' ')
        dictOfWords[index] = [(word,tokenizedWords.count(word)) for word in tokenizedWords]
    #  Calculate term frequency (TF)
    termFrequency = {}
    for i in range(0, len(documents)):
        listOfNoDuplicates = []
        for wordFreq in dictOfWords[i]:
            if wordFreq not in listOfNoDuplicates:
                listOfNoDuplicates.append(wordFreq)
            termFrequency[i] = listOfNoDuplicates
    normalizedTermFrequency = {}
    for i in range(0, len(documents)):
        sentence = dictOfWords[i]
        lenOfSentence = len(sentence)
    #    print(lenOfSentence)
        listOfNormalized = []
        for wordFreq in termFrequency[i]:
            normalizedFreq = wordFreq[1]/lenOfSentence
            listOfNormalized.append((wordFreq[0],normalizedFreq))
        normalizedTermFrequency[i] = listOfNormalized
    #  Calculate Inverse Term Frequency (IDF)
    allDocuments = ''
    for sentence in documents:
        allDocuments += sentence + ' '
    allDocumentsTokenized = allDocuments.split(' ')

    allDocumentsNoDuplicates = []
    for word in allDocumentsTokenized:
        if word not in allDocumentsNoDuplicates:
            allDocumentsNoDuplicates.append(word)

    # calculate the number of documents where the term t appears
    dictOfNumberOfDocumentsWithTermInside = {}
    for index, voc in enumerate(allDocumentsNoDuplicates):
        count = 0
        for sentence in documents:
            if voc in sentence:
                count += 1
        dictOfNumberOfDocumentsWithTermInside[index] = (voc, count)
    #calculate IDF
    dictOFIDFNoDuplicates = {}

    for i in range(0, len(normalizedTermFrequency)):
        listOfIDFCalcs = []
        for word in normalizedTermFrequency[i]:
            for x in range(0, len(dictOfNumberOfDocumentsWithTermInside)):
                if word[0] == dictOfNumberOfDocumentsWithTermInside[x][0]:
                    listOfIDFCalcs.append((word[0],math.log(len(documents)/dictOfNumberOfDocumentsWithTermInside[x][1])))
        dictOFIDFNoDuplicates[i] = listOfIDFCalcs
    #---------Multiply tf by idf for tf-idf

    dictOFTF_IDF = {}
    for i in range(0,len(normalizedTermFrequency)):
        listOFTF_IDF = []
        TFsentence = normalizedTermFrequency[i]
        IDFsentence = dictOFIDFNoDuplicates[i]
        for x in range(0, len(TFsentence)):

            listOFTF_IDF.append((TFsentence[x][0],TFsentence[x][1]*IDFsentence[x][1]))
        dictOFTF_IDF[i] = listOFTF_IDF
    summary = heapq.nlargest(result_size, dictOFTF_IDF, key=dictOFTF_IDF.get)
    S_count = 0
    summary_string = ""
    for s in summary:
        #print(documents[s])
        summary_string+=documents[s]
        S_count+=1
    return summary_string

allparagraphContent_Cleaned = "لا يوجد اسم ثانِ يُعرف به القمر غير القمر، بيد أن كلمة قمر تستخدم للإشارة إلى أي جرم سماوي أو صناعي، يقوم بمدار معين حول الأرض، أو أيِ من الكواكب الأخرى، فكوكب زحل مثلاً له ثمانية عشر قمراً تابعاً . وهناك تسمية أُخرى للقمر ويسمّى بها أحياناً وهي لونا . وجانب القمر الذي لا يُرى من الأرض يسمّى الجانب البعيد، أو الجانب المظلم، وسمّي بهذا الإسم لعدم قدرة بني البشر من النظر إليه من الأرض، فلو كانت هناك مركبة فضائية على هذا الجانب المظلم فسيتعذر الإتصال اللاسلكي بين الأرض وبين مركبة الفضاء . سيتركز هذا المقال عن القمر المتعارف عليه بين الناس، وهو القمر التابع للأرض . يقوم القمر بدورة كاملة حول الأرض مرة واحدة كل 4 أسابيع تقريباً، وفي كلّ ساعة تمر، يتحرك القمر بمقدار نصف درجة، ويمضي القمر في مدار له يميل على دائرة البروج بنحو 5 درجات.تقاس دورة القمر حول الأرض بالأشهر النجمية وبالأشهر الأقترانية.الدّورة النجمية وهي الفترة الزمنية التي يحتاجها القمر ليدور دورة واحدة حول الأرض بالنسبة للنجوم، وتستغرق 27 يوماً وثلث اليوم. الدّورة الأقترانية وهي الفترة الزمنية التي يحتاجها القمر ليدور دورة واحدة حول الأرض بالنسبة للشمس، وتستغرق 29 يوماً ونصف اليوم. وهي نفس الفترة التي يحتاجها القمر ليدور حول نفسه دورة كاملة، ولهذا السبب يرى الناظر من الأرض نفس الوجه للقمر.نتيجة تطابق الفترة الزمنية التي يأخذها القمر في دورانه حول نفسه وتلك التي يأخذها في دورانه حول الأرض، يجد أهل الأرض أن نفس الجانب من القمر مقابل للأرض ولا يتغيّر هذا الجانب . وتأثر حركة القمر بدورانه حول الأرض على بحار ومحيطات الأرض وتسبب ظاهرة المد والجزر التي نعرفها. وقد إختلف العلماء على مرّ السنين في أصل القمر وكيف آلت به الأمور على ما هو عليه، ومن أكثر النظريات التي تلقى تأييداً في الأوساط الفلكية، تلك التي تنادي بأن الأرض البكر التي نحن عليها قد إرتطم بها جسم كبير يقدّر حجمه بحجم كوكب المريخ وأقتطع هذا الجسم من الأرض ما اقتطع، وتناثر من الأرض قطع التحمت مع بعضها البعض وكوّنت القمر الذي نعرفه اليوم، وتعرف هذه النظرية بنظرية الصدمة الكبرى. وقد عمل العلماء على محاكاة نظرية الصدمة الكبرى في اغسطس من العام 2001 ونشرت المحاكاة في هذا الموقع. ولعلّ تشابه المواد المكوّنة لكتلة القمر، بتلك المعادن الموجودة على كوكب الأرض جعلت نظرية الصدمة الكبرى نظرية مقبولة في الأوساط العلمية . منذ أربع مليارات سنة ونصف، كان القمر مغطّى بالحمم البركانية المنصهرة والتي شكّلت محيطات من الحمم على سطح القمر. وتتكون قشرة القمر من المواد الأوّلية التّالية : يورانيوم، ثوريوم، بوتاسيوم، اكسجين، سيليكون، مغنيسيوم، حديد، تيتانيوم، كالسيوم، المنيوم، والهيدروجين. وعندما تسقط الإشعاعات الكونية على تلك العناصر الأولية، تقوم تلك العناصر على إنعكاس تلك الإشعاعات بخواصّ مختلفة تعتمد على طبيعة العنصر الأولي العاكس للإشعاع وبصورة إشعاعات جاما. وتجدر الإشارة ان بعض العناصر الأولية على سطح القمر تُصدر إشعاعات جاما بدون الحاجة لتعرّض تلك المواد الأولية لأي نوع من الإشعاعات الكونية كاليورانيوم أو البوتاسيوم والثوريوم.قامت النيازك والشهب بالإرتطام بالقمر مرات ومرات عديدة، ويُرى ذلك جلياُ في النتوءات الواضحة على سطح القمر. وقد حمل الكثير من تلك النيازك والشهب الماء، وحطّ على سطح القمر بمعيّة النيازك والشهب، وبمجرّد تعرض ماء النيازك والشهب لحرارة الشمس، يتفكك الماء لمكوّناته الأصلية (هيدروجين وأكسجين)، وتبدأ هذه العناصر في التطاير في الفضاء، وتبقى فرضية وجود الماء قائمة إمّا بوجوده على السطح، أو تحت قشرة القمر، وتقدّر كمية الماء على القمر ببليون متر مكعّب.يخسف القمر إذا وقعت الأرض بين أشعّة الشمس وبين جزء من القمر أو كلّ القمر، فظلّ الأرض حين تمرّ في مجراها حول الشمس يقع على القمر ويرى أهل الأرض وكأن القمر قد أُقتُطِع من نوره شيء. وننوه هنا أن ليس للقمر نور طبيعي وما النور السّاطع من القمر إلا إنعكاس أشعّة الشمس من على القمر إلى الأرض، فيراه من على الأرض وكأنه ذو نور ساطع. ولا تحدث ظاهرة خسوف القمر إلا في حالة القمر المكتمل (بدر). أمّا في ما يخصّ الكسوف، فيحصل الكسوف للشمس حين يحجب القمر أشعّة الشمس عن الأرض، وتحدث ظاهرة الكسوف في بداية تكوين القمر (هلال).أول من قام بإستكشاف الجانب المظلم من القمر كانت المركبة الفضائية السوفييتية لونا 2 عندما قامت بجولات مدارية حول القمر في 15 سبتمبر 1959، وأول من حطّ قدمه على سطح القمر هو نيل ارمسترونج، قائد المركبة الفضائية الأمريكية أبولو 11 في 20 يوليو 1969. وفي تلك الفترة، كانت الحرب الباردة في أوجها بين الإتحاد السوفييتي والولايات المتحدة، وأجّج هذا الإنجاز الأمريكي السباق إلى الفضاء بين الإتحاد السوفييتي والولايات المتّحدة. وقد وضع رائد الفضاء نيل أرمسترونج لوحة معدنية على سطح القمر كُتب فيها هنا حطّت أقدام رجال من كوكب الأرض في يوليو 1969 بعد الميلاد، لقد جئنا بسلام باسم البشرية، وقام رواد الفضاء الثلاثة بالتوقيع على اللوحة المعدنية كما وقّعها الرئيس الأمريكي آنذاك، ريتشارد نيكسون."

#print(infere_extractive_summarize(allparagraphContent_Cleaned , 14))

@app.get("/summarize/")
def summarize_api(paragraph: str, result_size: int):
    """
    Summarize endpoint.

    Parameters:
    - paragraph: The input paragraph to be summarized.
    - result_size: Number of sentences to include in the summary.

    Returns:
    - JSON response containing the summarized text.
    """
    try:
        summary = infere_extractive_summarize(paragraph, result_size)
        return {"summary": summary}
    except Exception as e:
        # raise HTTPException(status_code=500, detail="str(e)")
        return "belal"

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="127.0.0.1", port=8000)


